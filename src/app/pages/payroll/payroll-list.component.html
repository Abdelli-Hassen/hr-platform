<div class="payroll-container">
  <div class="page-header">
    <div class="header-content">
      <h1>Gestion de la Paie</h1>
      <p>Gérez et suivez les salaires en TND</p>
    </div>
    <button class="btn btn-primary" (click)="openForm()" *ngIf="!showForm">
      + Créer Fiche de Paie
    </button>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" *ngIf="showForm" (click)="closeForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingId ? 'Modifier Fiche' : 'Nouvelle Fiche de Paie' }}</h2>
        <button class="btn-close" (click)="closeForm()">×</button>
      </div>

      <form [formGroup]="payrollForm" class="payroll-form">
        <div class="form-grid">
          <div class="form-group">
            <label>Employé *</label>
            <select class="form-control" formControlName="employeeId" [disabled]="!!editingId">
              <option value="">Sélectionner...</option>
              <option *ngFor="let emp of employees" [value]="emp.id">
                {{ emp.firstName }} {{ emp.lastName }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>Mois *</label>
            <input type="number" class="form-control" formControlName="month" min="1" max="12" />
          </div>
          <div class="form-group">
            <label>Année *</label>
            <input type="number" class="form-control" formControlName="year" />
          </div>
          <div class="form-group">
            <label>Salaire de base (TND) *</label>
            <input type="number" class="form-control" formControlName="baseSalary" />
          </div>
          <div class="form-group">
            <label>Primes (TND)</label>
            <input type="number" class="form-control" formControlName="allowances" />
          </div>
          <div class="form-group">
            <label>Déductions (TND)</label>
            <input type="number" class="form-control" formControlName="deductions" />
          </div>
          <div class="form-group">
            <label>Statut *</label>
            <select class="form-control" formControlName="status">
              <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
            </select>
          </div>
        </div>

        <div class="salary-summary">
          <div class="summary-item">
            <span>Salaire net:</span>
            <strong>{{ formatCurrency((payrollForm.get('baseSalary')?.value || 0) + (payrollForm.get('allowances')?.value || 0) - (payrollForm.get('deductions')?.value || 0)) }}</strong>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeForm()">Annuler</button>
          <button type="button" class="btn btn-primary" (click)="savePayroll()" [disabled]="payrollForm.invalid || loading">
            {{ loading ? 'Enregistrement...' : 'Enregistrer' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <input
      type="text"
      placeholder="Rechercher par employé..."
      class="form-control"
      [(ngModel)]="searchText"
      (change)="onFilterChange()"
    />
    <select class="form-control" [(ngModel)]="filterMonth" (change)="onFilterChange()">
      <option value="0">Tous les mois</option>
      <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">{{ m }}</option>
    </select>
    <select class="form-control" [(ngModel)]="filterYear" (change)="onFilterChange()">
      <option value="0">Toutes les années</option>
      <option *ngFor="let y of [2024, 2025, 2026]" [value]="y">{{ y }}</option>
    </select>
    <select class="form-control" [(ngModel)]="filterStatus" (change)="onFilterChange()">
      <option value="">Tous les statuts</option>
      <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
    </select>
  </div>

  <!-- Payroll Table -->
  <div class="table-container">
    <table class="payroll-table">
      <thead>
        <tr>
          <th>Employé</th>
          <th>Période</th>
          <th>Salaire Base</th>
          <th>Primes</th>
          <th>Déductions</th>
          <th>Net</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let payroll of filteredPayrolls" class="table-row">
          <td>{{ getEmployeeName(payroll.employeeId) }}</td>
          <td>{{ payroll.month }}/{{ payroll.year }}</td>
          <td>{{ formatCurrency(payroll.baseSalary) }}</td>
          <td>{{ formatCurrency(payroll.allowances) }}</td>
          <td>{{ formatCurrency(payroll.deductions) }}</td>
          <td><strong>{{ formatCurrency(payroll.netSalary) }}</strong></td>
          <td>
            <span [ngClass]="['badge', getStatusClass(payroll.status)]">
              {{ payroll.status }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button
                *ngIf="payroll.status === 'pending'"
                class="btn btn-sm btn-success"
                (click)="approvePayroll(payroll.id)"
              >
                Approuver
              </button>
              <button
                *ngIf="payroll.status === 'validated'"
                class="btn btn-sm btn-success"
                (click)="payPayroll(payroll.id)"
              >
                Payer
              </button>
              <button class="btn btn-sm btn-info" (click)="openForm(payroll)">Modifier</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div *ngIf="filteredPayrolls.length === 0" class="empty-state">
      <p>Aucune fiche de paie trouvée</p>
    </div>
  </div>
</div>
